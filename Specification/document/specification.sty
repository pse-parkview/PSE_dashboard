\ProvidesPackage{specification}
\RequirePackage{xcolor}
\RequirePackage{rdfref-user,rdfref-query}
\RequirePackage{minipage-marginpar}

% cross referencing
\newcommand\tests[1]{%
  \AddTripleEx{#1}{pfl:is-tested}{yeah}
  \AddProperty{pfl:tests}{#1}}
\newcommand\fulfills[1]{%
  \AddTripleEx{#1}{pfl:is-fulfilled}{yeah}
  \AddProperty{pfl:fulfills}{#1}}
\newcommand\implementedby[2]{
  \AddTripleEx{#2}{pfl:is-implemented}{yeah}
  \AddTripleEx{#1}{pfl:implements}{#2}}

\newcommand\testlink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:tstid}}}
\newcommand\functionalitylink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:fncid}}}
\newcommand\criteriumlink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:crtid}}}
\newcommand\productdatalink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:datid}}}
\newcommand\scenariolink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:scnid}}}
\newcommand\caselink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:cseid}}}
\newcommand\marginid[1]{\marginpar{\centering\textbf{#1}}}

\newcommand\PrefixCriterium{C}
\newcommand\PrefixOptionalCriterium{OC}
\newcommand\PrefixNonCriterium{NC}
\newcommand\PrefixFunctional{FR}
\newcommand\PrefixNonFunctional{NF}
\newcommand\PrefixFunctionalOpt{OFR}
\newcommand\PrefixTest{T}
\newcommand\PrefixProductData{PD}
\newcommand\PrefixScenario{S}
\newcommand\PrefixCase{U}

\newcounter{criterium}
\newcounter{criteriumOpt}
\newcounter{criteriumNot}
\newcounter{functionality}
\newcounter{nonfunctionality}
\newcounter{test}
\newcounter{teststep}[test]
\newcounter{productData}
\newcounter{scenario}
\newcounter{case}

% document macros
\newcommand\criterium[3]{
  \stepcounter{criterium}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \IfProperty{#2}{pfl:is-fulfilled}{%
    \\ Implemented By: \Bind{?f}{pfl:fulfills}{#2}{ \functionalitylink{\GetVal{?f}} }
  }{{\color{red}{NOT IMPLEMENTED}}}
  \marginid{\PrefixCriterium\arabic{criterium}}
  \par#3
  \AddTripleEx{#2}{pfl:crtname}{#1}
  \AddTripleEx{#2}{pfl:crtid}{\PrefixCriterium\arabic{criterium}}
  \par}

\newcommand\criteriumOptional[3]{
  \stepcounter{criteriumOpt}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixOptionalCriterium\arabic{criteriumOpt}}
  \IfProperty{#2}{pfl:is-fulfilled}{%
    \\ Implemented By: \Bind{?f}{pfl:fulfills}{#2}{ \functionalitylink{\GetVal{?f}} }
  }{{\color{red} no according requirement}}
  \par#3
  \AddTripleEx{#2}{pfl:crtname}{#1}
  \AddTripleEx{#2}{pfl:crtid}{\PrefixOptionalCriterium\arabic{criteriumOpt}}
  \par}

\newcommand\criteriumNot[3]{
  \stepcounter{criteriumNot}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixNonCriterium\arabic{criteriumNot}}
  \par#3
  \AddTripleEx{#2}{pfl:crtname}{#1}
  \AddTripleEx{#2}{pfl:crtid}{\PrefixNonCriterium\arabic{criteriumNot}}
  \par}

\newcommand\functionality[2]{
  \stepcounter{functionality}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixFunctional\arabic{functionality}}
  \AddPropertyEx{pfl:fncname}{#1}
  \AddPropertyEx{pfl:fncid}{\PrefixFunctional\arabic{functionality}}
  \IfProperty{#2}{pfl:is-tested}{%
    \\ Tested By: \Bind{?t}{pfl:tests}{#2}{ \testlink{\GetVal{?t}} }
  }{{\color{red}{NOT TESTED}}\\}
  \par}

\newcommand\functionalityOpt[2]{
  \stepcounter{functionality}
  \begin{minipagewithmarginpars}{\textwidth}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixFunctionalOpt\arabic{functionality}}
  \AddPropertyEx{pfl:fncname}{#1}
  \AddPropertyEx{pfl:fncid}{\PrefixFunctionalOpt\arabic{functionality}}
  \IfProperty{#2}{pfl:is-tested}{%
    \\ Tested By: \Bind{?t}{pfl:tests}{#2}{ \testlink{\GetVal{?t}} }
  }{{\color{red}{NOT TESTED}}\\}
  \end{minipagewithmarginpars}
  \par}

\newcommand\nonFunctionality[2]{
  \stepcounter{nonfunctionality}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixNonFunctional\arabic{nonfunctionality}}
  \AddPropertyEx{pfl:fncname}{#1}
  \AddPropertyEx{pfl:fncid}{\PrefixNonFunctional\arabic{nonfunctionality}}
  \par}

\newcommand\test[2]{
  \stepcounter{test}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixTest\arabic{test}}
  \AddPropertyEx{pfl:tstname}{#1}
  \AddPropertyEx{pfl:tstid}{\PrefixTest\arabic{test}}
  \\ Tests: \Bind{#2}{pfl:tests}{?f}{ \functionalitylink{\GetVal{?f}} }
  \par}

\newcommand\productData[2]{
  \stepcounter{productData}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixProductData\arabic{productData}}
  \AddPropertyEx{pfl:datname}{#1}
  \AddPropertyEx{pfl:datid}{\PrefixProductData\arabic{productData}}
  \par}

\newcommand{\scenario}[4]{
  \stepcounter{scenario}
  \begin{minipagewithmarginpars}{\textwidth}
  \marginid{\textbf{\PrefixScenario\arabic{scenario}}}
  \textbf{Scenario name:} {#1}\phantomsection\rdflabel{#2}\par
  \textbf{Participating actor:} {#3}\par
  \textbf{Flow of events:} {#4}\par
  \textbf{Implements:} \Bind{#2}{pfl:implements}{?f}{ \caselink{\GetVal{?f}} }
  \end{minipagewithmarginpars}
  \AddTripleEx{#2}{pfl:scnname}{#1}
  \AddTripleEx{#2}{pfl:scnid}{\PrefixScenario\arabic{scenario}}
  \par}

\newcommand{\case}[7]{
  \stepcounter{case}
  \begin{minipagewithmarginpars}{\textwidth}
  \marginid{\textbf{\PrefixCase\arabic{case}}}
  \phantomsection\rdflabel{#2}
  \textbf{Use case name:} {#1}\par
  \textbf{Description:} {#3}\par
  \textbf{Participating actors:} {#4}\par
  \textbf{Entry conditions:} {#5}\par
  \textbf{Flow of events:} {#6}\par
  \textbf{Exit conditions:} {#7}\par
  \IfProperty{#2}{pfl:is-implemented}{%
      \textbf{Implemented by:} \Bind{?f}{pfl:implements}{#2}{ \scenariolink{\GetVal{?f}} }
  }{
      {\color{red}{NO SCENARIO}}\par
  }
  \end{minipagewithmarginpars}
  \AddTripleEx{#2}{pfl:csename}{#1}
  \AddTripleEx{#2}{pfl:cseid}{\PrefixCase\arabic{case}}
  \par}


\newcommand\teststep[3]{\stepcounter{teststep}
{\PrefixTest\arabic{test}.\arabic{teststep}}
\begin{minipage}[t]{0.8\textwidth}\raggedright
    \textbf{State:} #1\par
    \textbf{Action:} #2\par
    \textbf{Reaction:} #3\par
\end{minipage}
\par}

\newcommand\teststepnostate[2]{\stepcounter{teststep}
{\PrefixTest\arabic{test}.\arabic{teststep}}
\begin{minipage}[t]{0.8\textwidth}\raggedright
    \textbf{Action:} #1\par
    \textbf{Reaction:} #2\par
\end{minipage}
\par}
\newcommand\figref[1]{\figurename~\ref{#1}}