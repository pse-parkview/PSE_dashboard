\ProvidesPackage{specification}
\RequirePackage{xcolor}
\RequirePackage{rdfref-user,rdfref-query}

% cross referencing
\newcommand\tests[1]{%
  \AddTripleEx{#1}{pfl:is-tested}{yeah}
  \AddProperty{pfl:tests}{#1}}
\newcommand\fulfills[1]{%
  \AddTripleEx{#1}{pfl:is-fulfilled}{yeah}
  \AddProperty{pfl:fulfills}{#1}}
\newcommand\testlink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:tstid}}}
\newcommand\functionalitylink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:fncid}}}
\newcommand\criteriumlink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:crtid}}}
\newcommand\marginid[1]{\marginpar{\centering\textbf{#1}}}
\newcommand\productdatalink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:dataid}}}

\newcommand\PrefixCriterium{C}
\newcommand\PrefixOptionalCriterium{OC}
\newcommand\PrefixNonCriterium{NC}
\newcommand\PrefixFunctional{FR}
\newcommand\PrefixNonFunctional{NF}
\newcommand\PrefixTest{T}
\newcommand\PrefixProductData{PD}

\newcounter{criterium}
\newcounter{criteriumOpt}
\newcounter{criteriumNot}
\newcounter{functionality}
\newcounter{nonfunctionality}
\newcounter{test}
\newcounter{teststep}[test]
\newcounter{productData}

% document macros
\newcommand\criterium[2]{
  \stepcounter{criterium}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixCriterium\arabic{criterium}}
  \AddPropertyEx{pfl:crtname}{#1}
  \AddPropertyEx{pfl:crtid}{\PrefixCriterium\arabic{criterium}}
  \IfProperty{#2}{pfl:is-fulfilled}{%
    \\ Implemented By: \Bind{?f}{pfl:fulfills}{#2}{ \functionalitylink{\GetVal{?f}} }
  }{{\color{red}{NOT IMPLEMENTED}}}
  \par}

\newcommand\criteriumOptional[2]{
  \stepcounter{criteriumOpt}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixOptionalCriterium\arabic{criteriumOpt}}
  \AddPropertyEx{pfl:crtname}{#1}
  \AddPropertyEx{pfl:crtid}{\PrefixOptionalCriterium\arabic{criteriumOpt}}
  \IfProperty{#2}{pfl:is-fulfilled}{%
    \\ Implemented By: \Bind{?f}{pfl:fulfills}{#2}{ \functionalitylink{\GetVal{?f}} }
  }{{\color{red} no according requirement}}
  \par}

\newcommand\criteriumNot[2]{
  \stepcounter{criteriumNot}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixNonCriterium\arabic{criteriumNot}}
  \AddPropertyEx{pfl:crtname}{#1}
  \AddPropertyEx{pfl:crtid}{\PrefixNonCriterium\arabic{criteriumNot}}
  \par}

\newcommand\functionality[2]{
  \stepcounter{functionality}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixFunctional\arabic{functionality}}
  \AddPropertyEx{pfl:fncname}{#1}
  \AddPropertyEx{pfl:fncid}{\PrefixFunctional\arabic{functionality}}
  \IfProperty{#2}{pfl:is-tested}{%
    \\ Tested By: \Bind{?t}{pfl:tests}{#2}{ \testlink{\GetVal{?t}} }
  }{{\color{red}{NOT TESTED}}\\}
  Implements: \Bind{#2}{pfl:fulfills}{?c}{ \criteriumlink{\GetVal{?c}} }
  \par}

\newcommand\nonFunctionality[2]{
  \stepcounter{nonfunctionality}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixNonFunctional\arabic{nonfunctionality}}
  \AddPropertyEx{pfl:fncname}{#1}
  \AddPropertyEx{pfl:fncid}{\PrefixNonFunctional\arabic{nonfunctionality}}
  \par}

\newcommand\test[2]{
  \stepcounter{test}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixTest\arabic{test}}
  \AddPropertyEx{pfl:tstname}{#1}
  \AddPropertyEx{pfl:tstid}{\PrefixTest\arabic{test}}
  \\ Tests: \Bind{#2}{pfl:tests}{?f}{ \functionalitylink{\GetVal{?f}} }
  \par}

\newcommand\productData[2]{
  \stepcounter{productData}
  \par\textbf{#1}\phantomsection\rdflabel{#2}
  \marginid{\PrefixProductData\arabic{productData}}
  \AddPropertyEx{pfl:dataname}{#1}
  \AddPropertyEx{pfl:dataid}{\PrefixNonFunctional\arabic{productData}}
  \par}

\newcommand\teststep[3]{\stepcounter{teststep}
{\PrefixTest\arabic{test}.\arabic{teststep}}
\begin{minipage}[t]{0.8\textwidth}\raggedright
\textbf{State:} #1\par
\textbf{Action:} #2\par
\textbf{Reaction:} #3\par
\end{minipage}
\par}

\newcommand\teststepnostate[2]{\stepcounter{teststep}
{\PrefixTest\arabic{test}.\arabic{teststep}}
\begin{minipage}[t]{0.8\textwidth}\raggedright
	\textbf{Action:} #1\par
	\textbf{Reaction:} #2\par
\end{minipage}
\par}

% new doc macros
\newcommand{\scenario}[3]{\begin{minipage}{\textwidth}
\textbf{Scenario name:} #1 \\
\textbf{Participating actor:} #2 \\
\textbf{Flow of events:} #3
\end{minipage}
}

\newcommand{\case}[6]{\begin{minipage}{\textwidth}
\textbf{Use case name:} #1 \\
\textbf{Participating actors:} #2 \\
\textbf{Entry conditions:} #3 \\
\textbf{Flow of events:} #4 
\textbf{Exit conditions:} #5 \\
\textbf{Quality requirements:} #6
\end{minipage}
}
